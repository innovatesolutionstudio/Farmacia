<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/resources/css/micompras.css" />
    <title>Mis Compras</title>
</head>
<body>
    <div class="top-header">
        <a href="/pagina_pedidos/clientes_index/:idSucursal" class="logo">
            <img src="/resources/images/iconos/farmacia.ico" alt="Farmacia 25 de Julio">
        </a>     
        <ul>
            <li><a href="/pagina_pedidos/clientes_index/:idSucursal" class="dropdown">Inicio</a></li>
            <li><a href="/pagina_pedidos/productos/:idSucursal" class="dropdown">Tienda</a></li>
            <li><a href="/pagina_pedidos/consultas" class="dropdown">Consultas</a></li>
            <li><a href="/pagina_pedidos/miscompras" class="dropdown">Compras</a></li>
            <li><a href="/pagina_pedidos/recordatorio" class="dropdown">Recordatorio</a></li>
        </ul>
        <a href="#" class="cart-icon">
            <i class="fas fa-shopping-cart"></i>
            <span class="cart-count">0</span>
        </a>
        <a href="#" class="profile-icon">
            <i class="fas fa-user"></i>
            <span class="profile-name">Perfil</span>
        </a>
    </div>
    <div class="main-container">
        <h1>Mis Compras</h1>
        <% if (compras.length > 0) { %>
            <ul>
                <% compras.forEach(compra => { %>
                    <li>
                        <strong>Venta ID:</strong> <%= compra.ID_Venta %><br>
                        <strong>Fecha:</strong> <%= compra.Fecha_Venta %><br>
                        <strong>Total:</strong> <%= compra.Total_Venta %> Bs.<br>
                        <strong>Sucursal:</strong> <%= compra.Sucursal %><br>
                        <!-- Botón para ver más detalles -->
                        <button class="purchase-item-button" onclick="verDetallesVenta('<%= compra.ID_Venta %>')">Ver detalles de la venta</button>

                    </li>
                <% }) %>
            </ul>
        <% } else { %>
            <p>No tienes compras registradas.</p>
        <% } %>
    </div>
    <!-- Modal de Detalles -->
    <div id="detallesModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="cerrarModal()">&times;</span>
            <h2>Detalles de Compra</h2>
            <div class="order-details-container">
                <div class="products-section">
                    <h3 class="section-title">Productos</h3>
                    <div id="productosLista"></div> <!-- Aquí se mostrarán los productos -->
                </div>
            </div>
            <a href="#" class="download-pdf">Descargar PDF</a>
        </div>
    </div>    
    <script>
        // Función para cargar las compras desde localStorage
        function cargarMisCompras() {
            const compras = JSON.parse(localStorage.getItem('compras')) || [];
            const purchaseListContainer = document.getElementById('purchaseList');
            purchaseListContainer.innerHTML = '';

            if (compras.length === 0) {
                purchaseListContainer.innerHTML = '<div class="empty-message">No tienes compras previas.</div>';
                return;
            }

            compras.forEach((compra, index) => {
                const compraElemento = document.createElement('div');
                compraElemento.classList.add('purchase-item');

                let productosDetalles = compra.productos.map(producto => 
                    `<span>${producto.name} - ${producto.quantity} x Bs ${producto.price.toFixed(2)}</span>`
                ).join('');

                compraElemento.innerHTML = 
                    `<div class="purchase-item-details">
                        <h3>Pedido #${compras.length - index}</h3>
                        <p><strong>Fecha:</strong> ${compra.fecha}</p>
                        <p><strong>Cliente:</strong> ${compra.cliente.nombre}</p>
                        <div class="productos-lista">
                            <strong>Productos:</strong>
                            ${productosDetalles}
                        </div>
                    </div>
                    <div class="purchase-item-total">
                        Total: Bs ${compra.total.toFixed(2)}
                    </div>
                    <button class="purchase-item-button" onclick="verDetallesCompra(${index})">Ver detalles</button> `;

                purchaseListContainer.appendChild(compraElemento);
            });
        }

        function verDetallesVenta(ID_Detalle_Venta) {
    // Llamada a la nueva ruta para obtener los detalles de la venta
    fetch(`/pagina_pedidos/detalleVenta/${ID_Detalle_Venta}`)
    .then(response => response.json())
    .then(detallesVenta => {
        console.log(detallesVenta); // Para verificar la estructura de los datos
        const modal = document.getElementById('detallesModal');
        const productosLista = document.getElementById('productosLista');
        
        // Mostrar los detalles en el modal
        productosLista.innerHTML = detallesVenta.map(item => 
            `<div class="product-item">
                <span class="product-info">
                    ID Detalle Venta: ${item.ID_Detalle_Venta} - 
                    ID Venta: ${item.ID_Venta} - 
                    Nombre Producto: ${item.Nombre_Producto} - 
                    Cantidad: ${item.Cantidad}
                </span>
            </div>`
        ).join('');
        
        modal.style.display = 'block';
    })
    .catch(error => {
        console.error('Error al obtener los detalles de la venta:', error);
    });

}



        function cerrarModal() {
            document.getElementById('detallesModal').style.display = 'none';
        }

        cargarMisCompras();
    </script>
</body>
</html>
